!function(){"use strict";const e=1,t=2,n=3;const s=new class{constructor(){this.level=t,this.categories=new Set(["error","warn"]),this.prefix="[LenQuant]"}async init(){try{const e=await chrome.storage.local.get(["debugMode","logCategories"]);e.debugMode&&(this.level=n,this.categories=new Set(["error","warn","info","debug","dom","api","auth"])),e.logCategories&&(this.categories=new Set(e.logCategories))}catch(e){}}setLevel(e){this.level=e}enableCategory(e){this.categories.add(e)}disableCategory(e){this.categories.delete(e)}log(e,...t){this.level>=n&&this.categories.has(e)&&console.log(`${this.prefix}:${e}`,...t)}info(e,...n){this.level>=t&&console.info(`${this.prefix}:${e}`,...n)}warn(t,...n){this.level>=e&&console.warn(`${this.prefix}:${t}`,...n)}error(e,...t){console.error(`${this.prefix}:${e}`,...t)}time(e){this.level>=n&&console.time(`${this.prefix} ${e}`)}timeEnd(e){this.level>=n&&console.timeEnd(`${this.prefix} ${e}`)}group(e){this.level>=n&&console.group(`${this.prefix} ${e}`)}groupEnd(){this.level>=n&&console.groupEnd()}},i={API_BASE_URL:"https://lenquant.com/api/extension",WS_URL:"wss://lenquant.com/ws/extension",BINANCE_FUTURES_API:"https://fapi.binance.com",BACKEND_TIMEOUT_MS:3e3,ANALYSIS_CACHE_TTL:3e3,BEHAVIOR_CHECK_INTERVAL:6e4,AUTO_REFRESH_INTERVAL:3e4,EVENT_FLUSH_INTERVAL:5e3,PANEL_WIDTH:320,DEBOUNCE_MS:300,OBSERVER_THROTTLE_MS:500,EVENT_BUFFER_SIZE:100,MAX_OHLCV_CANDLES:300,USE_CLIENT_FALLBACK:!0,ENABLE_TUTORIAL:!0,ENABLE_SOUND_ALERTS:!1},o=80,a=65,r=50;class l{constructor(e={}){this.exchange=e.exchange,this.onContextChange=e.onContextChange||(()=>{}),this.throttleMs=e.throttleMs||i.OBSERVER_THROTTLE_MS,this.observers=[],this.lastContext=null,this.lastUpdate=0,this.pendingUpdate=null}start(){s.info("observer","Starting context observation"),this.observeTradePanel(),this.observeNavigation(),this.captureContext()}stop(){s.info("observer","Stopping context observation"),this.observers.forEach(e=>e.disconnect()),this.observers=[],this.pendingUpdate&&(clearTimeout(this.pendingUpdate),this.pendingUpdate=null)}observeTradePanel(){const e=['[class*="trade-panel"]','[class*="orderForm"]','[class*="tradingPanel"]',"main"];let t=null;for(const n of e)if(t=document.querySelector(n),t)break;t||(s.warn("observer","Trade panel not found, observing body"),t=document.body);const n=new MutationObserver(this.handleMutations.bind(this));n.observe(t,{childList:!0,subtree:!0,characterData:!0}),this.observers.push(n),s.log("observer","Observing container:",t.className?.slice(0,50))}observeNavigation(){let e=window.location.href;const t=new MutationObserver(()=>{window.location.href!==e&&(e=window.location.href,s.log("observer","URL changed:",e),setTimeout(()=>this.captureContext(),500))});t.observe(document.body,{childList:!0,subtree:!1}),this.observers.push(t),window.addEventListener("popstate",()=>{s.log("observer","Popstate event"),setTimeout(()=>this.captureContext(),500)})}handleMutations(e){e.some(e=>{const t=e.target.className||"";return!(t.includes("price")&&!t.includes("entry"))&&(!t.includes("depth")&&(!t.includes("orderbook")&&!t.includes("chart")))})&&this.scheduleCapture()}scheduleCapture(){const e=Date.now();e-this.lastUpdate>=this.throttleMs?this.captureContext():this.pendingUpdate||(this.pendingUpdate=setTimeout(()=>{this.pendingUpdate=null,this.captureContext()},this.throttleMs-(e-this.lastUpdate)))}captureContext(){this.lastUpdate=Date.now();const e=this.exchange.extractContext();this.getContextKey(e)!==this.getContextKey(this.lastContext)&&(s.log("observer","Context changed:",e),this.lastContext=e,this.onContextChange(e))}getContextKey(e){return e?`${e.symbol}:${e.timeframe}:${e.leverage}`:""}forceUpdate(){this.lastContext=null,this.captureContext()}getCurrentContext(){return this.lastContext||this.exchange.extractContext()}}class c{constructor(e){this.container=e,this.lastAnalysis=null}updateAnalysis(e){if(e){this.lastAnalysis=e;try{this.updateSignalBadge(e),this.updateGrade(e),this.updateScore(e),this.updateRiskFlags(e),this.updateLeverageRecommendation(e),this.updateReason(e),this.panel?.updateMiniSignal&&this.panel.updateMiniSignal(),s.log("panel","Analysis updated")}catch(e){s.error("panel","Error updating analysis:",e)}}}updateSignalBadge(e){const t=this.container.querySelector(".lq-signal-badge"),n=this.container.querySelector(".lq-signal-text");if(!t||!n)return;t.classList.remove("buy","wait","caution","neutral");const s=e.signal?.toLowerCase()||"analyzing";t.classList.add(s),n.textContent=s.toUpperCase()}updateGrade(e){const t=this.container.querySelector(".lq-grade-letter");if(!t)return;const n=e.confidence||0;let s="D";n>=o?s="A":n>=a?s="B":n>=r&&(s="C"),t.textContent=s,t.className=`lq-grade-letter grade-${s.toLowerCase()}`}updateScore(e){const t=this.container.querySelector(".lq-score-fill"),n=this.container.querySelector(".lq-score-text");if(!t||!n)return;const s=e.confidence||0;t.style.width=`${Math.min(100,s)}%`,n.textContent=`${s}%`}updateRiskFlags(e){const t=this.container.querySelector(".lq-risk-flags");if(!t)return;t.innerHTML="";(e.risk_flags||[]).forEach(e=>{const n=document.createElement("span");n.className=`lq-risk-flag ${e.level}`,n.textContent=e.message,t.appendChild(n)})}updateLeverageRecommendation(e){const t=this.container.querySelector(".lq-leverage-range");if(!t)return;const n=e.leverage_recommendation||{min:5,max:15};t.textContent=`${n.min}-${n.max}x`}updateReason(e){const t=this.container.querySelector(".lq-reason-text");t&&(t.textContent=e.reason||"Analysis complete")}showLoading(){const e=this.container.querySelector(".lq-signal-badge"),t=this.container.querySelector(".lq-signal-text");e&&t&&(e.className="lq-signal-badge neutral",t.textContent="ANALYZING...")}showError(e){const t=this.container.querySelector(".lq-reason-text");t&&(t.textContent=e);const n=this.container.querySelector(".lq-signal-badge"),s=this.container.querySelector(".lq-signal-text");n&&s&&(n.className="lq-signal-badge caution",s.textContent="ERROR")}showAlert(e){const t=document.createElement("div");t.className=`lq-alert ${e.level||"info"}`,t.innerHTML=`\n      <span class="lq-alert-icon">${e.icon||"‚ÑπÔ∏è"}</span>\n      <span class="lq-alert-text">${e.message}</span>\n      <button class="lq-alert-close">√ó</button>\n    `,this.container.appendChild(t),setTimeout(()=>{t.remove()},5e3),t.querySelector(".lq-alert-close").addEventListener("click",()=>{t.remove()})}updateUserInfo(e){const t=this.container.querySelector(".lq-tier-badge");t&&(t.textContent=(e?.tier||"FREE").toUpperCase(),t.className=`lq-tier-badge tier-${(e?.tier||"free").toLowerCase()}`),this.lastAnalysis?.symbol&&this.updateMTFSection(this.lastAnalysis.symbol,e)}updateMTFSection(e,t){const n=this.container.querySelector(".lq-mtf-section");if(!n)return;const s=n.querySelector(".lq-mtf-content"),i=n.querySelector(".lq-mtf-locked");if(!(t?.features?.includes("mtf_analysis")||"premium"===t?.tier||"trial"===t?.tier))return s.style.display="none",void(i.style.display="flex");i.style.display="none",s.style.display="block";n.querySelector(".lq-mtf-status").textContent="Loading...",this.requestMTFAnalysis(e)}async requestMTFAnalysis(e){try{const t=await chrome.runtime.sendMessage({type:"GET_MTF_ANALYSIS",symbol:e,timeframes:["15m","1h","4h","1d"]});if(t.error)return void this.updateMTFError("Error loading MTF data");this.updateMTFData(t)}catch(e){s.error("panel","MTF analysis error:",e),this.updateMTFError("Error")}}updateMTFData(e){const t=this.container.querySelector(".lq-mtf-section"),n=t.querySelector(".lq-mtf-table tbody"),s=t.querySelector(".lq-mtf-confluence-value"),i=t.querySelector(".lq-mtf-status");n.innerHTML=e.timeframes.map(e=>`\n      <tr>\n        <td>${e.timeframe}</td>\n        <td class="trend-${e.trend}">${"up"===e.trend?"‚Üë":"down"===e.trend?"‚Üì":"‚Üí"}</td>\n        <td class="rsi-${e.rsi>70?"high":e.rsi<30?"low":"neutral"}">${e.rsi}</td>\n        <td class="signal-${e.signal}">${e.signal}</td>\n      </tr>\n    `).join(""),s.textContent=e.confluence,s.className=`value lq-mtf-confluence-value ${e.confluence.toLowerCase()}`,i.textContent=""}updateMTFError(e){const t=this.container.querySelector(".lq-mtf-status");t&&(t.textContent=e)}}class d{constructor(e){this.container=e,this.isDragging=!1,this.dragOffset={x:0,y:0},this.onDragEnd=null,this.init()}init(){const e=this.container.querySelector(".lq-panel-header");e&&(e.style.cursor="move",e.addEventListener("mousedown",this.onMouseDown.bind(this)),e.addEventListener("selectstart",e=>{this.isDragging&&e.preventDefault()}))}onMouseDown(e){if(e.target.closest(".lq-btn-icon, .lq-btn-action"))return;this.isDragging=!0;const t=this.container.getBoundingClientRect();this.dragOffset={x:e.clientX-t.left,y:e.clientY-t.top},e.preventDefault(),document.addEventListener("mousemove",this.onMouseMove.bind(this)),document.addEventListener("mouseup",this.onMouseUp.bind(this)),this.container.classList.add("lq-dragging")}onMouseMove(e){if(!this.isDragging)return;const t=e.clientX-this.dragOffset.x,n=e.clientY-this.dragOffset.y,s=window.innerWidth-this.container.offsetWidth,i=window.innerHeight-this.container.offsetHeight,o=Math.max(0,Math.min(t,s)),a=Math.max(0,Math.min(n,i));this.container.style.left=`${o}px`,this.container.style.top=`${a}px`,this.container.style.right="auto"}onMouseUp(){if(this.isDragging){this.isDragging=!1,this.container.classList.remove("lq-dragging");const e=this.container.getBoundingClientRect();this.onDragEnd&&this.onDragEnd(e.left,e.top),document.removeEventListener("mousemove",this.onMouseMove.bind(this)),document.removeEventListener("mouseup",this.onMouseUp.bind(this))}}destroy(){const e=this.container.querySelector(".lq-panel-header");e&&e.removeEventListener("mousedown",this.onMouseDown.bind(this))}}const h="lq_panel_position";class u{static async savePosition(e,t){try{await chrome.storage.local.set({[h]:{x:e,y:t,timestamp:Date.now()}})}catch(e){console.warn("[LenQuant] Could not save panel position:",e)}}static async loadPosition(){try{const e=(await chrome.storage.local.get(h))[h];if(e&&this.isValidPosition(e))return e}catch(e){console.warn("[LenQuant] Could not load panel position:",e)}return null}static isValidPosition(e){return e&&"number"==typeof e.x&&"number"==typeof e.y&&e.x>=0&&e.y>=0&&e.x<window.innerWidth&&e.y<window.innerHeight}static getDefaultPosition(){return{x:window.innerWidth-340,y:80}}}class p{constructor(e={}){this.container=null,this.updater=null,this.dragHandler=null,this.isCollapsed=!1,this.isVisible=!0,this.isMinimized=!1,this.miniIcon=null,this.exchange=e.exchange,this.onExplainClick=e.onExplainClick||(()=>{}),this.onBookmarkClick=e.onBookmarkClick||(()=>{}),this.onSyncClick=e.onSyncClick||(()=>{}),this.onBreakClick=e.onBreakClick||(()=>{})}async inject(){this.container=document.createElement("div"),this.container.className="lq-panel",this.container.innerHTML='\n  <div class="lq-panel-header">\n    <div class="lq-panel-title">\n      <span class="lq-logo">LenQuant</span>\n      <span class="lq-tier-badge">FREE</span>\n    </div>\n    <div class="lq-panel-actions">\n      <button class="lq-btn-icon lq-btn-collapse" title="Collapse">‚àí</button>\n      <button class="lq-btn-icon lq-btn-close" title="Close">√ó</button>\n    </div>\n  </div>\n\n  <div class="lq-panel-content">\n    <div class="lq-context-info">\n      <div class="lq-symbol-display">\n        <span class="lq-symbol">BTCUSDT</span>\n        <span class="lq-timeframe">1h</span>\n      </div>\n      <div class="lq-leverage-display">\n        <span class="lq-leverage">10x</span>\n      </div>\n    </div>\n\n    <div class="lq-analysis-section">\n      <div class="lq-signal-badge neutral">\n        <span class="lq-signal-text">ANALYZING</span>\n      </div>\n\n      <div class="lq-grade-display">\n        <div class="lq-grade-circle">\n          <span class="lq-grade-letter">-</span>\n        </div>\n        <div class="lq-grade-label">Setup Grade</div>\n      </div>\n\n      <div class="lq-score-bar">\n        <div class="lq-score-fill" style="width: 0%"></div>\n        <span class="lq-score-text">0%</span>\n      </div>\n    </div>\n\n    <div class="lq-risk-section">\n      <div class="lq-risk-flags">\n        \x3c!-- Risk flags will be inserted here --\x3e\n      </div>\n      <div class="lq-leverage-recommendation">\n        <span class="lq-leverage-label">Recommended Leverage:</span>\n        <span class="lq-leverage-range">5-15x</span>\n      </div>\n    </div>\n\n    <div class="lq-reason-section">\n      <div class="lq-reason-text">Loading analysis...</div>\n    </div>\n\n    <div class="lq-mtf-section">\n      <div class="lq-section-header">\n        <span>üìä Multi-Timeframe Analysis</span>\n        <div class="lq-mtf-controls">\n          <button class="lq-btn-mtf-refresh" title="Refresh MTF data">‚Üª</button>\n          <span class="lq-mtf-status"></span>\n        </div>\n      </div>\n      <div class="lq-mtf-content" style="display: none;">\n        <table class="lq-mtf-table">\n          <thead>\n            <tr>\n              <th>TF</th>\n              <th>Trend</th>\n              <th>RSI</th>\n              <th>Signal</th>\n            </tr>\n          </thead>\n          <tbody>\n            \x3c!-- Populated dynamically --\x3e\n          </tbody>\n        </table>\n        <div class="lq-mtf-confluence">\n          <span class="label">Confluence:</span>\n          <span class="value lq-mtf-confluence-value">--</span>\n        </div>\n      </div>\n      <div class="lq-mtf-locked" style="display: none;">\n        <span>üîí Premium feature</span>\n        <button class="lq-btn lq-btn-unlock-mtf">Unlock</button>\n      </div>\n    </div>\n  </div>\n\n  <div class="lq-panel-footer">\n    <button class="lq-btn-action lq-btn-explain" title="Explain Analysis">\n      <span class="lq-btn-icon">üí°</span>\n      Explain\n    </button>\n    <button class="lq-btn-action lq-btn-bookmark" title="Bookmark Setup">\n      <span class="lq-btn-icon">üìñ</span>\n      Save\n    </button>\n    <button class="lq-btn-action lq-btn-sync" title="Sync to Journal">\n      <span class="lq-btn-icon">üì§</span>\n      Sync\n    </button>\n    <button class="lq-btn-action lq-btn-break" title="Take a Break">\n      <span class="lq-btn-icon">‚è∏Ô∏è</span>\n      Break\n    </button>\n  </div>\n',document.body.appendChild(this.container),this.updater=new c(this.container),this.updater.panel=this,this.dragHandler=new d(this.container),await this.loadPosition(),this.setupEventHandlers(),s.info("panel","Panel injected")}async loadPosition(){const e=await u.loadPosition();e&&this.isValidPosition(e.x,e.y)?(this.container.style.left=`${e.x}px`,this.container.style.top=`${e.y}px`):(this.container.style.right="20px",this.container.style.top="80px")}isValidPosition(e,t){return e>=0&&e<window.innerWidth-100&&t>=0&&t<window.innerHeight-100}setupEventHandlers(){this.container.querySelector(".lq-btn-collapse")?.addEventListener("click",()=>{this.toggleCollapse()}),this.container.querySelector(".lq-btn-close")?.addEventListener("click",()=>{this.hide()}),this.container.querySelector(".lq-panel-header")?.addEventListener("dblclick",()=>{this.toggleMinimize()}),this.container.querySelector(".lq-btn-explain")?.addEventListener("click",()=>{this.onExplainClick()}),this.container.querySelector(".lq-btn-bookmark")?.addEventListener("click",()=>{this.onBookmarkClick()}),this.container.querySelector(".lq-btn-sync")?.addEventListener("click",()=>{this.onSyncClick()}),this.container.querySelector(".lq-btn-break")?.addEventListener("click",()=>{this.onBreakClick()}),this.dragHandler.onDragEnd=async(e,t)=>{await u.savePosition(e,t)}}toggleCollapse(){this.isCollapsed=!this.isCollapsed;const e=this.container.querySelector(".lq-panel-content"),t=this.container.querySelector(".lq-panel-footer"),n=this.container.querySelector(".lq-btn-collapse");this.isCollapsed?(e.style.display="none",t.style.display="none",n.textContent="+",n.title="Expand panel"):(e.style.display="block",t.style.display="flex",n.textContent="‚àí",n.title="Collapse panel")}show(){this.container.style.display="block",this.isVisible=!0}hide(){this.container.style.display="none",this.isVisible=!1}updateAnalysis(e){this.updater.updateAnalysis(e)}showLoading(){this.updater.showLoading()}showError(e){this.updater.showError(e)}showAlert(e){this.updater.showAlert(e)}updateUserInfo(e){this.updater.updateUserInfo(e)}toggleMinimize(){this.isMinimized?this.restore():this.minimize()}minimize(){this.isMinimized=!0,this.container.style.display="none",this.miniIcon||(this.miniIcon=document.createElement("div"),this.miniIcon.className="lq-mini-icon",this.miniIcon.innerHTML=`\n        <img src="${chrome.runtime.getURL("icons/icon48.png")}" alt="LQ" />\n        <span class="lq-mini-signal"></span>\n      `,this.miniIcon.title="Click to expand LenQuant panel",new d(this.miniIcon),this.miniIcon.addEventListener("click",()=>this.restore()),document.body.appendChild(this.miniIcon)),this.miniIcon.style.display="flex",this.updateMiniSignal()}restore(){this.isMinimized=!1,this.container.style.display="block",this.miniIcon&&(this.miniIcon.style.display="none")}updateMiniSignal(){if(!this.miniIcon)return;const e=this.miniIcon.querySelector(".lq-mini-signal"),t=this.updater?.lastAnalysis?.signal||"wait";e.className=`lq-mini-signal signal-${t}`}isShown(){return this.isVisible&&"none"!==this.container?.style.display}destroy(){this.dragHandler?.destroy(),this.miniIcon?.remove(),this.container?.remove(),this.container=null,this.miniIcon=null}}class m{constructor(){if(new.target===m)throw new Error("ExchangeInterface is abstract");this.name="unknown",this.displayName="Unknown Exchange",this.urlPatterns=[]}extractSymbol(){throw new Error("Not implemented")}extractTimeframe(){throw new Error("Not implemented")}extractLeverage(){throw new Error("Not implemented")}extractMarginType(){throw new Error("Not implemented")}extractPositions(){throw new Error("Not implemented")}extractContext(){return{symbol:this.extractSymbol(),timeframe:this.extractTimeframe(),leverage:this.extractLeverage(),marginType:this.extractMarginType(),positions:this.extractPositions(),exchange:this.name,market:"futures",timestamp:Date.now()}}getOHLCVEndpoint(e,t,n){throw new Error("Not implemented")}parseOHLCVResponse(e){throw new Error("Not implemented")}normalizeSymbol(e){return e}normalizeTimeframe(e){return e}}const g={binance:new class extends m{constructor(){super(),this.name="binance",this.displayName="Binance Futures",this.urlPatterns=["https://www.binance.com/*/futures/*"],this.apiBase="https://fapi.binance.com",this.selectors={symbol:['[class*="symbol-title"]','[class*="symbolTitle"]'],timeframe:['[class*="timeframe"] button.active','[class*="interval"] .active'],leverage:['button[class*="leverage"]','div[class*="leverage"] button'],marginType:['[class*="margin-type"]','[class*="marginType"]'],position:['[class*="position-row"]','[class*="positionItem"]']}}extractSymbol(){for(const e of this.selectors.symbol){const t=document.querySelector(e);if(t){const e=t.textContent?.match(/([A-Z0-9]+USDT?)/);if(e)return e[1]}}const e=window.location.pathname.match(/futures\/([A-Z0-9]+)/i);return e?e[1].toUpperCase():null}extractTimeframe(){for(const e of this.selectors.timeframe){const t=document.querySelector(e);if(t){const e=t.textContent?.trim().toLowerCase();if(/^\d+[mhdw]$/.test(e))return e}}return"1h"}extractLeverage(){for(const e of this.selectors.leverage){const t=document.querySelector(e);if(t){const e=t.textContent?.match(/(\d+)[xX]/);if(e){const t=parseInt(e[1],10);if(t>=1&&t<=125)return t}}}const e=document.querySelectorAll('button, [role="button"]');for(const t of e)if(/^\d{1,3}[xX]$/.test(t.textContent?.trim()))return parseInt(t.textContent.match(/\d+/)[0],10);return null}extractMarginType(){for(const e of this.selectors.marginType){const t=document.querySelector(e);if(t){const e=t.textContent?.toLowerCase();if(e?.includes("cross"))return"cross";if(e?.includes("isolated"))return"isolated"}}return"cross"}extractPositions(){const e=[];for(const t of this.selectors.position){document.querySelectorAll(t).forEach(t=>{const n=t.textContent?.match(/([A-Z0-9]+USDT?)/);n&&e.push({symbol:n[1]})})}return e}getOHLCVEndpoint(e,t,n=300){const s=this.normalizeTimeframe(t);return`${this.apiBase}/fapi/v1/klines?symbol=${e}&interval=${s}&limit=${n}`}parseOHLCVResponse(e){return e.map(e=>({timestamp:e[0],open:parseFloat(e[1]),high:parseFloat(e[2]),low:parseFloat(e[3]),close:parseFloat(e[4]),volume:parseFloat(e[5])}))}normalizeTimeframe(e){return e.toLowerCase()}}};const y={binance:{primary:"#f0b90b",positive:"#0ecb81",negative:"#f6465d",background:"#1e2329",surface:"#2b3139",text:"#eaecef",textSecondary:"#848e9c"},bybit:{primary:"#f7a600",positive:"#20b26c",negative:"#ef454a",background:"#0b0e11",surface:"#1c1e22",text:"#ffffff",textSecondary:"#81858c"},okx:{primary:"#00c853",positive:"#00c853",negative:"#ff4d4f",background:"#121212",surface:"#1f1f1f",text:"#ffffff",textSecondary:"#8c8c8c"}};let f={symbol:null,timeframe:null,leverage:null,position:null},b=null,v=null,q=null,x=null,w=0;function C(e){f={...f,...e},s.log("content","Context updated:",f),f.symbol&&E()}async function E(){if(f.symbol)try{const e=await chrome.runtime.sendMessage({type:"CONTEXT_CHANGED",symbol:f.symbol,timeframe:f.timeframe||"1h",context:f});e.analysis&&(b=e.analysis,q?.updateAnalysis(e.analysis),s.info("content","Analysis updated")),e.cooldown?.active&&s.log("content","Analysis cooldown active"),e.cooldown?.active&&s.log("content","Analysis cooldown active")}catch(e){s.error("content","Analysis error:",e),q?.showError("Analysis failed")}else s.warn("content","No symbol available for analysis")}async function S(){s.info("content","Initializing modular content script");try{const e=function(){const e=window.location.href;for(const[t,n]of Object.entries(g))for(const t of n.urlPatterns)if(new RegExp(t.replace(/\*/g,".*")).test(e))return n;return null}();if(!e)return void s.log("content","Unsupported exchange");s.log("content",`Detected: ${e.displayName}`),function(e){const t=y[e]||y.binance,n=document.documentElement;n.style.setProperty("--lq-primary",t.primary),n.style.setProperty("--lq-positive",t.positive),n.style.setProperty("--lq-negative",t.negative),n.style.setProperty("--lq-bg",t.background),n.style.setProperty("--lq-surface",t.surface),n.style.setProperty("--lq-text",t.text),n.style.setProperty("--lq-text-secondary",t.textSecondary)}(e.name),v=new l({exchange:e,onContextChange:C}),v.start(),q=new p({exchange:e,onExplainClick:()=>L(),onBookmarkClick:()=>function(){if(!b||!f.symbol)return;chrome.runtime.sendMessage({type:"BOOKMARK_SETUP",analysis:b,context:f})}(),onSyncClick:()=>function(){if(!b||!f.symbol)return;chrome.runtime.sendMessage({type:"SYNC_TRADE",analysis:b,context:f})}(),onBreakClick:()=>{chrome.runtime.sendMessage({type:"TAKE_BREAK",context:f})}}),await q.inject();const t=(await chrome.storage.sync.get("settings")).settings||{};!1!==t.autoShow||q.hide(),setTimeout(()=>{f.symbol&&E()},1e3),s.info("content","Initialization complete")}catch(e){s.error("content","Initialization error:",e)}!async function(){if(!b)return;const e=await chrome.storage.sync.get("settings");if(!(e.settings||{}).autoExplain)return;const t=b.grade?.toUpperCase();if(!["A","B"].includes(t))return;const n=(await chrome.storage.local.get("license")).license;if(!["trial","pro","premium"].includes(n?.tier))return;const i=`${f.symbol}:${f.timeframe}`;if(x===i)return;x=i;const o=Date.now();if(o-w<3e5)return;w=o,s.log("content","Auto-explaining grade",t,"setup"),L()}()}function L(){b&&chrome.runtime.sendMessage({type:"EXPLAIN_ANALYSIS",analysis:b,context:f})}s.init(),async function(){try{const e=(await chrome.storage.sync.get("settings")).settings||{};return e.apiUrl&&(i.API_BASE_URL=e.apiUrl.replace(/\/$/,"")+"/api/extension"),e.wsUrl&&(i.WS_URL=e.wsUrl.replace(/^https?/,"wss")+"/ws/extension"),i}catch(e){return console.error("[LenQuant] Failed to load config:",e),i}}().then(()=>{s.info("content","Configuration loaded")}),chrome.runtime.onMessage.addListener((e,t,n)=>{switch(e.type){case"TRIGGER_ANALYSIS":return E().then(()=>n({success:!0})),!0;case"SHOW_PANEL":q?.show(),n({success:!0});break;case"HIDE_PANEL":q?.hide(),n({success:!0});break;case"GET_CONTEXT":n({success:!0,context:f,analysis:b});break;default:n({success:!1,error:"Unknown message type"})}}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",S):S()}();
