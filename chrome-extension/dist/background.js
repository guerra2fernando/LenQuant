!function(){"use strict";const e=1,t=2,a=3;const r=new class{constructor(){this.level=t,this.categories=new Set(["error","warn"]),this.prefix="[LenQuant]"}async init(){try{const e=await chrome.storage.local.get(["debugMode","logCategories"]);e.debugMode&&(this.level=a,this.categories=new Set(["error","warn","info","debug","dom","api","auth"])),e.logCategories&&(this.categories=new Set(e.logCategories))}catch(e){}}setLevel(e){this.level=e}enableCategory(e){this.categories.add(e)}disableCategory(e){this.categories.delete(e)}log(e,...t){this.level>=a&&this.categories.has(e)&&console.log(`${this.prefix}:${e}`,...t)}info(e,...a){this.level>=t&&console.info(`${this.prefix}:${e}`,...a)}warn(t,...a){this.level>=e&&console.warn(`${this.prefix}:${t}`,...a)}error(e,...t){console.error(`${this.prefix}:${e}`,...t)}time(e){this.level>=a&&console.time(`${this.prefix} ${e}`)}timeEnd(e){this.level>=a&&console.timeEnd(`${this.prefix} ${e}`)}group(e){this.level>=a&&console.group(`${this.prefix} ${e}`)}groupEnd(){this.level>=a&&console.groupEnd()}},n={API_BASE_URL:"https://lenquant.com/api/extension",WS_URL:"wss://lenquant.com/ws/extension",BINANCE_FUTURES_API:"https://fapi.binance.com",BACKEND_TIMEOUT_MS:3e3,ANALYSIS_CACHE_TTL:3e3,BEHAVIOR_CHECK_INTERVAL:6e4,AUTO_REFRESH_INTERVAL:3e4,EVENT_FLUSH_INTERVAL:5e3,PANEL_WIDTH:320,DEBOUNCE_MS:300,OBSERVER_THROTTLE_MS:500,EVENT_BUFFER_SIZE:100,MAX_OHLCV_CANDLES:300,USE_CLIENT_FALLBACK:!0,ENABLE_TUTORIAL:!0,ENABLE_SOUND_ALERTS:!1};async function s(){try{const e=(await chrome.storage.sync.get("settings")).settings||{};return e.apiUrl&&(n.API_BASE_URL=e.apiUrl.replace(/\/$/,"")+"/api/extension"),e.wsUrl&&(n.WS_URL=e.wsUrl.replace(/^https?/,"wss")+"/ws/extension"),n}catch(e){return console.error("[LenQuant] Failed to load config:",e),n}}async function o(e,t={}){const{timeout:a=5e3,...r}=t;try{const t=await async function(e,t={},a=5e3){const r=new AbortController,n=setTimeout(()=>r.abort(),a);try{return await fetch(e,{...t,signal:r.signal})}finally{clearTimeout(n)}}(e,{...r,headers:{"Content-Type":"application/json",...r.headers}},a),n=await t.json().catch(()=>null);return t.ok?{success:!0,data:n}:{success:!1,error:n?.detail||n?.message||`HTTP ${t.status}`,status:t.status}}catch(e){return"AbortError"===e.name?{success:!1,error:"Request timeout",isTimeout:!0}:{success:!1,error:e.message||"Network error",isNetworkError:!0}}}let i=null;r.init(),s().then(()=>{r.info("background","Configuration loaded")});const c=new Map;async function l(){try{const e=await async function(){if(i)return i;try{const e=chrome.runtime.getManifest();if(e.oauth2?.client_id)return i=e.oauth2.client_id,r.log("auth","Got client ID from manifest"),i}catch(e){r.warn("auth","Could not read manifest:",e)}try{const e=await o(`${n.API_BASE_URL}/auth/config`);if(e.success&&e.data.google_client_id)return i=e.data.google_client_id,r.log("auth","Got client ID from backend"),i}catch(e){r.warn("auth","Could not fetch client ID from backend:",e)}return r.error("auth","No Google client ID available"),null}();if(!e)throw new Error("Google OAuth not configured");const t=chrome.identity.getRedirectURL(),a=new URL("https://accounts.google.com/o/oauth2/v2/auth");a.searchParams.set("client_id",e),a.searchParams.set("redirect_uri",t),a.searchParams.set("response_type","token id_token"),a.searchParams.set("scope","email profile openid"),a.searchParams.set("nonce",Math.random().toString(36).substring(2));const s=await new Promise((e,t)=>{chrome.identity.launchWebAuthFlow({url:a.toString(),interactive:!0},a=>{chrome.runtime.lastError?t(new Error(chrome.runtime.lastError.message)):e(a)})}),c=new URLSearchParams(new URL(s).hash.substring(1)).get("id_token");if(!c)return{success:!1,message:"No ID token in OAuth response"};const l=await o(`${n.API_BASE_URL}/auth/google`,{method:"POST",body:JSON.stringify({id_token:c})});return l.success?(await chrome.storage.local.set({authToken:l.data.token,userInfo:l.data.user}),r.info("auth","Google authentication successful"),{success:!0,user:l.data.user}):(r.error("auth","Backend authentication failed:",l.error),{success:!1,message:l.error})}catch(e){return r.error("auth","Google authentication error:",e),{success:!1,message:e.message}}}async function u(e,t){try{r.log("background","Context changed:",e.symbol,e.timeframe),t.tab&&c.set(t.tab.id,{exchange:e.context?.exchange||"unknown",symbol:e.symbol,lastUpdate:Date.now()});const a=(await chrome.storage.local.get("authToken")).authToken;if(!a)return{analysis:{signal:"wait",confidence:0,reason:"Please sign in to access analysis",source:"client"}};const s=(await chrome.storage.local.get("lastAnalysisTime")).lastAnalysisTime||0,i=Date.now()-s,l=3e4;if(i<l){const e=Math.ceil((l-i)/1e3);return{cooldown:{active:!0,remainingSeconds:e,message:`Please wait ${e} seconds before requesting another analysis`}}}const u=await o(`${n.API_BASE_URL}/analysis`,{method:"POST",headers:{Authorization:`Bearer ${a}`},body:JSON.stringify({symbol:e.symbol,timeframe:e.timeframe,context:e.context,domData:e.domData})});if(u.success)return await chrome.storage.local.set({lastAnalysisTime:Date.now()}),r.info("background","Analysis successful for:",e.symbol),{analysis:u.data};if(r.warn("background","Analysis failed:",u.error),n.USE_CLIENT_FALLBACK){const t=function(e){const{symbol:t,timeframe:a}=e,r=["buy","wait","caution"],n=r[Math.floor(Math.random()*r.length)],s=Math.floor(40*Math.random())+30;return{signal:n,confidence:s,reason:`Client-side analysis for ${t} (${a})`,leverage_recommendation:{min:5,max:15},risk_flags:[]}}(e);return{analysis:{...t,source:"client"}}}return{analysis:{signal:"wait",confidence:0,reason:"Analysis temporarily unavailable",source:"client"}}}catch(e){return r.error("background","Context change error:",e),{analysis:{signal:"wait",confidence:0,reason:"Analysis error occurred",source:"client"}}}}async function h(){try{const e=await chrome.storage.local.get(["behaviorData","lastBehaviorCheck"]),t=e.behaviorData||[],a=e.lastBehaviorCheck||0,r=36e5;if(Date.now()-a<r)return{alerts:[]};const n=function(e){const t=[],a=e.filter(e=>"trade"===e.type&&Date.now()-e.timestamp<864e5);a.length>10&&t.push({type:"overtrading",level:"warning",message:"High trading frequency detected. Consider taking a break.",icon:"âš ï¸"});const r=e.filter(e=>"loss"===e.type&&e.amount>100&&Date.now()-e.timestamp<6048e5);r.length>3&&t.push({type:"losses",level:"caution",message:"Multiple large losses detected. Review risk management.",icon:"ðŸ“‰"});return t}(t);return await chrome.storage.local.set({lastBehaviorCheck:Date.now()}),{alerts:n}}catch(e){return r.error("background","Behavior check error:",e),{alerts:[]}}}chrome.runtime.onMessage.addListener((e,t,a)=>{switch(r.log("background","Message received:",e.type),e.type){case"GOOGLE_AUTH":return l().then(a),!0;case"CONTEXT_CHANGED":return u(e).then(a),!0;case"CAPTURE_SCREENSHOT":return async function(){try{return{screenshot:await chrome.tabs.captureVisibleTab(null,{format:"png"})}}catch(e){return r.error("background","Screenshot capture error:",e),{error:e.message}}}().then(a),!0;case"CHECK_BEHAVIOR":return h().then(a),!0;case"GET_MTF_ANALYSIS":return async function(e){try{const{symbol:t,timeframes:a}=e,s=(await chrome.storage.local.get("authToken")).authToken;if(!s)return{error:"Not authenticated"};const i=await o(`${n.API_BASE_URL}/analysis/mtf`,{method:"POST",headers:{Authorization:`Bearer ${s}`},body:JSON.stringify({symbol:t,timeframes:a})});return i.success?i.data:(r.warn("background","MTF analysis failed:",i.error),{error:i.error})}catch(e){return r.error("background","MTF analysis error:",e),{error:"MTF analysis failed"}}}(e).then(a),!0;case"GET_SESSION":a({sessionId:`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`});break;default:r.warn("background","Unknown message type:",e.type),a({success:!1,error:"Unknown message type"})}}),chrome.runtime.onInstalled.addListener(e=>{"install"===e.reason?(r.info("background","Extension installed"),chrome.storage.sync.set({settings:{autoShow:!0,debugMode:!1}})):"update"===e.reason&&r.info("background","Extension updated")}),chrome.storage.onChanged.addListener((e,t)=>{"sync"===t&&e.settings&&(r.log("background","Settings changed, reloading config"),s())}),chrome.tabs.onRemoved.addListener(e=>{c.delete(e)}),r.info("background","Background script initialized")}();
