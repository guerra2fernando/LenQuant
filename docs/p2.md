# Phase 2 — Strategy Genome & Multi-Account Experimentation

**Objective:** Make the lab smarter by evolving, scoring, and explaining strategies. You'll run multiple virtual accounts, each with unique or mutated strategy DNA, evaluate them daily, and feed the best results back into the pool.

## 1 — Goals

- Represent every trading strategy as a structured genome (its parameters, rules, risk settings).
- Run parallel simulations across many virtual accounts using those genomes.
- Evaluate each run on ROI, Sharpe, drawdown, consistency, and forecast-alignment score.
- Mutate top performers to spawn new variants.
- Produce a daily leaderboard + evolution report.
- Retain complete logs for reproducibility.
- Deliver the Phase 2 "Evolution Lab" UI: genome explorer, mutation queue, and leaderboard visualizations with Tailwind + shadcn, matching light/dark themes.

## 2 — New components

| Module | Purpose |
|--------|---------|
| `strategy_genome/encoding.py` | Convert strategy dict ↔ genome vector |
| `strategy_genome/evolver.py` | Mutation & crossover of genomes |
| `manager/experiment_runner.py` | Run N accounts concurrently |
| `evaluation/metrics.py` | Compute ROI, Sharpe, etc. |
| `reports/leaderboard.py` | Generate HTML/JSON reports |
| `db/collections/strategies` | Store genomes & history |

## 3 — Strategy Genome structure

```json
{
  "strategy_id": "ema-cross-9-21-v4",
  "family": "ema-cross",
  "params": {
    "ema_short": 9,
    "ema_long": 21,
    "take_profit_pct": 0.02,
    "stop_loss_pct": 0.01,
    "risk_pct": 0.05
  },
  "uses_forecast": true,
  "forecast_weight": 0.4,
  "mutation_parent": "ema-cross-9-21-v3",
  "generation": 4,
  "fitness": { "roi": 0.032, "sharpe": 1.1 },
  "created_at": "2025-11-04T00:00:00Z"
}
```

Store in `strategies` collection with index on `family`, `generation`.

## 4 — Evolver

```python
def mutate(genome):
    g = copy.deepcopy(genome)
    for p in g['params']:
        if random()<0.3:
            delta = g['params'][p]*random.uniform(-0.2,0.2)
            g['params'][p]+=delta
    g['mutation_parent']=genome['strategy_id']
    g['generation']=genome['generation']+1
    g['strategy_id']=f"{g['family']}-gen{g['generation']}-{uuid4().hex[:4]}"
    return g
```

Crossover combines parameters of two parents.

## 5 — Experiment runner

1. Pull current champion genomes from DB.
2. Spawn ~20 mutations each.
3. Run backtests in parallel (e.g., multiprocessing or Dask).
4. Collect results → `sim_runs`.
5. Update genome fitness in `strategies`.

**CLI:**

```bash
python manager/experiment_runner.py --symbol BTC/USDT --period 30d --accounts 50
```

**Async pipeline:** `POST /api/experiments/run` now enqueues a Celery task backed by Redis (`manager.tasks.run_experiment_cycle_task`). Track progress with `GET /api/experiments/tasks/{task_id}` while workers pull pending queue entries, execute simulations, and update leaderboard artifacts without blocking API requests.

## 6 — Metrics

| Metric | Formula |
|--------|---------|
| ROI | `(end_equity/start_equity − 1)` |
| Sharpe | `(mean r − r_f)/std r × √N` |
| Max drawdown | `max(peak−trough)/peak` |
| Forecast alignment | `% of trades agreeing with forecast direction` |
| Stability | `Sharpe / variance of returns` |

## 7 — Daily leaderboard & evolution report

**reports/leaderboard.py**

- Generate ranking by composite fitness = `ROI × Sharpe × Alignment`.
- Save top 10 genomes to `/reports/leaderboards/YYYYMMDD.json` and `.html`.
- API endpoint `/api/leaderboard/today`.

### Frontend scope (Phase 2 UI)

**New / Updated Pages**
- `/evolution` (new) — Evolution Lab hub with leaderboard, ROI vs risk scatter, lineage graph, mutation queue; consumes `GET /api/leaderboard/today`, `GET /api/strategies/genomes`, `GET /api/strategies/lineage`, `GET /api/experiments/queue`.
- `/strategies` — Adds comparison drawer showing genome metadata + experiment history via `GET /api/strategies/{id}`.
- `/settings/experiments` (new nested page) — Configure mutation rates, experiment concurrency, and leaderboard thresholds via `GET/PUT /api/settings/experiments`.

**Key Components**
- `EvolutionLeaderboardTable`, `FitnessScatterChart`, `LineageGraph`, `MutationQueueDrawer`.
- `GenomeComparisonPanel`, `ExperimentFilters`, `ExperimentStatusBadge`.
- `SettingsForm` variants for mutation parameters with inline validation feedback.

**Backend Integrations**
- Leaderboard & history: `GET /api/leaderboard/today`, `GET /api/leaderboard/history`.
- Genome management: `GET /api/strategies/genomes`, `GET /api/strategies/{id}`, `POST /api/strategies/promote`, `POST /api/strategies/archive`.
- Lineage: `GET /api/strategies/lineage` returns nodes with `parent` field and links for mutation chains.
- Mutation queue: `GET /api/experiments/queue`, `POST /api/experiments/run` (trigger run), `POST /api/experiments/reprioritize` (drag-and-drop order).
- Settings: `GET/PUT /api/settings/experiments` to persist UI controls.
- **Note:** Assistant endpoint (`POST /api/assistant/query`) is implemented backend-only; frontend integration pending (see Phase 4 for full conversational UI).

**UX & QA**
- Keyboard-accessible drag-and-drop for mutation queue (aria-grabbed states).
- Empty/paused states for each panel using shadcn `Alert` and `Skeleton` placeholders.
- Playwright test verifying `/evolution` renders milestone widgets in both themes and queue interactions update ordering.
- Storybook for `EvolutionLeaderboardTable`, `LineageGraph`, `MutationQueueDrawer` with mocked data.

## 8 — AI assistant integration

Add conversational endpoint:

**POST /api/assistant/query**

```json
{
  "question": "Why did strat-A outperform strat-B yesterday?"
}
```

The backend retrieves metrics, differences in params, and replies with text summary.

Use an LLM Google AI (api key from google data studio and openai api) via function call to produce natural-language insight.

Environment-driven provider selection lets you toggle between OpenAI (`ASSISTANT_LLM_PROVIDER=openai`, `OPENAI_MODEL`, `OPENAI_API_KEY`) or Google Gemini (`ASSISTANT_LLM_PROVIDER=google`, `GOOGLE_MODEL`, `GOOGLE_API_KEY`). If unset, the route falls back to deterministic summaries.

**Status:** Backend endpoint implemented and functional. Frontend UI integration is deferred to Phase 4 (Personal Assistant + Conversational Analysis), where a full chat interface will be built.

## 9 — Tests

- Mutations preserve valid parameter bounds.
- Top N selection deterministic for fixed seed.
- Simulation of 50 accounts completes < 10 min on 16 threads.
- Leaderboards sum to N entries and include fitness fields.

## 10 — Acceptance criteria

- ✅ Genome schema stored & mutated.
- ✅ Automated experiment cycles produce daily results.
- ✅ Leaderboards accessible in UI + API, with Evolution Lab frontend covering leaderboard, scatter, and lineage in both light and dark themes.
- ✅ Lineage API includes `parent` field in nodes for proper mutation chain visualization.
- ✅ Experiment settings deduplicated (shared constant from `strategy_genome.repository`).
- ⚠️ Conversational analysis backend endpoint available (`POST /api/assistant/query`), but frontend UI integration deferred to Phase 4.

## 11 — Implementation Status (Nov 10, 2025)

**Completed**
- Celery-powered experiment orchestration: `manager.tasks.run_experiment_cycle_task` consumes Redis-backed queues, allowing `/api/experiments/run` to respond immediately while background workers execute simulations and regenerate leaderboards. Docker Compose now ships `redis` + `worker` services.
- Assistant endpoint upgraded to a provider-agnostic LLM client. Runtime selection (`ASSISTANT_LLM_PROVIDER`) supports OpenAI or Google Gemini with env-configured models/keys, retaining the deterministic fallback when keys are absent.
- Strategy persistence wired through `strategy_genome/repository.py` with seed management, fitness updates, queue storage, and leaderboard recording.
- Experiment orchestration delivered via `manager/experiment_runner.py` and CLI `scripts/run_experiments.py`, running `simulator.runner.run_simulation` across champion genomes, updating metrics, and regenerating daily leaderboard artifacts in `reports/leaderboard.py`.
- New FastAPI routes exposed: `/api/strategies/*`, `/api/leaderboard/*`, `/api/experiments/*`, `/api/assistant/query`, plus `/api/settings/experiments` for stored evolution preferences.
- Evolution Lab frontend shipped at `/evolution` with `EvolutionLeaderboardTable`, `FitnessScatterChart`, `LineageGraph`, `GenomeComparisonPanel`, and `MutationQueueDrawer` components alongside queue analytics and status badges.
- Experiment settings UI added at `/settings/experiments`, persisting defaults through the new settings endpoint, and `Layout` navigation updated with an Evolution shortcut.
- Phase 2 unit coverage expanded (`tests/test_phase2_utils.py`) to lock composite-scoring heuristics and leaderboard rendering; pytest run attempted (see gaps).

**Recent Fixes (Post-Phase 2 Review)**
- **Lineage API fix:** Updated `/api/strategies/lineage` to include `parent` field in each node, enabling proper mutation chain visualization in `LineageGraph` component. Previously, nodes lacked parent references, causing all entries to display as "seed" parents.
- **Settings deduplication:** Removed duplicate `DEFAULT_EXPERIMENT_SETTINGS` constant from `api/routes/settings.py`, now importing from `strategy_genome/repository.py` as the single source of truth. This prevents configuration drift between API defaults and experiment runner defaults.

**Next Up**
- Add richer data visualisations (canvas lineage graph, fitness history sparklines) and Playwright coverage for Evolution Lab interactions.
- Deepen assistant responses with expanded evidence retrieval (e.g., trade-level diagnostics, feature attributions) once additional analytics endpoints land.

**Known gaps / risks**
- Provide Redis credentials/SSL guidance for production deployments (Compose defaults target local dev).
- LLM usage depends on external API quotas and connectivity; fallbacks still available but less insightful.
- Promotion thresholds remain manual; tie Celery job completion to auto-promotion heuristics when stability metrics mature.
- **Assistant frontend:** The `/api/assistant/query` endpoint is implemented and tested backend-only. A conversational UI will be added in Phase 4 as part of the Personal Assistant feature set.