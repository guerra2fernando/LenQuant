# Phase 5 — Exchange Integration & Real Trading Modes (Paper → Live with Guard Rails)

**Objective:** Connect to exchanges (start with Binance testnet), support paper trading and cautious live trading modes (manual and auto), implement robust execution, risk controls, and full auditability. Prioritize safety, observability, and rollback ability.

## 1 — High-level goals

- Secure exchange connectors supporting: testnet (paper), live with limited permissions.
- Execution engine with robust order handling: limit & market orders, slippage, retries, partial fills management, and order reconciliation.
- Risk & compliance layer: per-trade and per-day limits, global kill-switches, mandatory stop-loss enforcement, exposure control, and position limits.
- Real-time monitoring & alerting for fills, slippage anomalies, or rule breaches.
- Full logging & proof-of-execution storage for every order (exchange receipts, tx IDs, server logs).
- Build the Phase 5 trading console frontend: live positions, order blotter, risk controls, and approval flows using Tailwind + shadcn with synchronized light/dark themes.

## 2 — New components & architecture

| Component | Purpose |
|-----------|---------|
| `exec/connector.py` | Exchange adapters: ccxt + exchange-specific wrappers |
| `exec/order_manager.py` | Order lifecycle, fill tracking, reconciliation |
| `exec/risk_manager.py` | Implements guard rails & pre-trade checks |
| `exec/trade_auditor.py` | Proof-of-execution storage & reconciliation |
| `exec/settlement.py` | Handles balances, PnL calculation, end-of-day settlement |
| `monitoring/trade_alerts.py` | Alerts via Slack/Telegram/Email on anomalies |
| `api/routes/trade.py` | Endpoints to send trade orders, query status, cancel |

## 3 — Connectors: testnet → live

### 3.1 Supported approach

- Use **ccxt** for generic connectivity; use exchange-specific SDKs for features ccxt lacks.
- Start with **Binance testnet** (futures & spot if needed).

**Connector interface:**

```python
class ExchangeConnector:
    def get_balance(self): ...
    def create_order(self, symbol, side, type, quantity, price=None, params={}): ...
    def fetch_order(self, order_id): ...
    def cancel_order(self, order_id): ...
    def get_orderbook(self, symbol, limit=5): ...
```

### 3.2 Testnet-first policy

- Always route first executions to testnet by default.
- Promotion to live requires a one-time explicit toggle and 2FA or password.

## 4 — Order manager & execution model

### 4.1 Order lifecycle

1. **Prepare:** `risk_manager` pre-checks (size caps, exposure, balance).
2. **Place:** `order_manager` calls `connector.create_order`, stores returned `client_order_id`.
3. **Monitor:** poll or WS to track fills; update position and balance.
4. **Reconcile:** compare exchange fill data with internal logs; if mismatch, flag & alert.
5. **Close:** upon target/stop or manual close, execute close order and record PnL.

### 4.2 Execution policies

- **Default:** place limit orders near best bid/ask for less slippage. If not filled within `t_timeout`, escalate to market order optionally.
- **For large sizes:** implement TWAP/VWAP execution strategy (break orders).
- **Slippage handling:** set `max_slippage_pct`, and abort if market moves beyond tolerance.

### 4.3 Partial fills

Handle partial fills by adjusting remaining quantity, re-evaluating stop/take parameters, and re-submitting sliced orders.

## 5 — Risk manager & guard rails

### 5.1 Pre-trade checks

- Sufficient balance check (including margin for fees).
- Max per-trade USD cap (configurable).
- Max daily loss threshold not to be exceeded.
- Max total open exposure limit.
- Minimum confidence threshold for automated trades.
- If trade triggers leverage usage: check leverage limits and margin rules per exchange.

### 5.2 Runtime protection

- **Global kill-switch endpoint:** `POST /api/admin/kill-switch` — immediate cancel open orders, close allowed positions to market or safe mode.
- **Stop-loss enforcement:** if a stop is triggered, `order_manager` must attempt immediate execution.
- **Auto-disable auto-mode** if slippage or network errors exceed thresholds.

### 5.3 Human overrides

For trades above `sensitive_threshold_usd`, require manual multi-factor approval in UI and recorded in audit logs.

## 6 — Paper trading & simulated live

### 6.1 Paper-first execution

- All recommendations and approvals execute against a **paper account** by default until owner toggles live for a specific strategy/amount.
- Paper trading uses same `order_manager` codepath but routes to connector stub that simulates fills using realistic slippage model.

### 6.2 Transition plan to live

- **Stage 1:** testnet execution (Binance testnet)
- **Stage 2:** live with micro capital (e.g., $X/day cap)
- **Stage 3:** scale up after N days of validated positive expectancy and controlled risk metrics

## 7 — Balances, margin, and accounting

### 7.1 Ledger model

Maintain internal ledger:

- `wallet_balance` (USD)
- `positions` (symbol, side, qty, avg_price, margin_used)
- `realized_pnl`, `unrealized_pnl`

Reconcile with exchange balances every minute; if discrepancy > tolerance, pause trading and alert.

### 7.2 Fees and funding

- Account for spot fees and for futures funding payments where applicable.
- Support both spot and margin/futures trading as toggles; margin must be opt-in and have additional guard rails.

## 8 — Audit, proofs & compliance

### 8.1 Proof-of-execution

- Save exchange receipts (order JSON), timestamps, client IDs, and raw WS messages.
- Keep signed snapshots of ledger at end-of-day (hash+timestamp) for tamper-evidence.

### 8.2 Reconciliation job

Daily job: reconcile internal trades vs exchange statements, produce `reconciliation_report` with discrepancies and actions.

## 9 — Monitoring, alerting & observability

- **Logs:** structured JSON logs for order events, errors, and decisions.
- **Alerts:**
  - **Immediate:** order failures, stop-loss triggered, kill-switch used.
  - **Threshold:** slippage > X%, failed reconciliations, repeated timeouts.
- **Dashboards:** real-time position table, open orders list, recent fills, PnL summary.
- **Integrations:** Slack/Telegram for critical alerts, email for daily reconciliation.

### Frontend scope (Phase 5 UI)

**New / Updated Pages**
- `/trading` (new) — Trading Control Center with tabs for Paper, Testnet, Live; consumes `GET /api/trading/positions`, `GET /api/trading/orders`, `GET /api/trading/fills`, WebSocket `/ws/trading`.
- `/risk` (new) — Risk dashboard summarizing exposure, limits, reconciliation status; consumes `GET /api/risk/summary`, `GET /api/risk/breaches`.
- `/settings/trading` (new) — Configure per-mode caps, kill-switch behavior, alert channels via `GET/PUT /api/settings/trading`.
- `/assistant` — Gains inline "send to trading" action to open approval modal with pre-filled order.

**Key Components**
- `TradingTabs`, `PositionsTable`, `OrderBlotter`, `FillsFeed`, `ExecutionLatencyChart`.
- `RiskGaugeCard`, `ExposureDonutChart`, `KillSwitchPanel`, `AlertStream`.
- `ApprovalWizard`, `MFAChallenge`, `OrderAmendForm`, `AccountSelector`.
- `SettingsTradingForm` with channel selectors (Slack/Telegram/email).

**Backend Integrations**
- Streaming: WebSocket `/ws/trading` for order/fill updates; fallback polling `GET /api/trading/stream`.
- Orders & positions: `GET /api/trading/positions`, `GET /api/trading/orders`, `POST /api/trading/orders`, `POST /api/trading/orders/{id}/cancel`, `POST /api/trading/orders/{id}/amend`.
- Risk controls: `GET /api/risk/summary`, `GET /api/risk/breaches`, `POST /api/admin/kill-switch`, `POST /api/risk/acknowledge`.
- Settings: `GET/PUT /api/settings/trading`, `POST /api/settings/trading/test-alert`.
- Audit: `GET /api/audit/trading?limit=...` displayed in risk page.

**UX & QA**
- Ensure WebSocket updates reconcile with client state (optimistic updates w/ fallback).
- Inline editing uses accessible modals; highlight compliance warnings with `Alert`.
- Playwright test covering kill-switch activation, order placement, and theme toggle.
- Storybook for `PositionsTable`, `ApprovalWizard`, `RiskGaugeCard`, `OrderBlotter`.

## 10 — Testing & staging

### 10.1 Unit tests

- Connector mocks: simulate exchange responses for `create_order`, `fetch_order`, and `cancel`.
- Risk manager tests: ensure pre-trade checks for different thresholds.
- Reconciliation tests: given exchange statement, internal ledger updates correctly.

### 10.2 Integration tests

- Full path: recommendation → user approve → place order (testnet) → simulated fill → update ledger → reconcile.
- Simulated network failures: ensure retries and idempotency (safe to retry `create_order`).

### 10.3 Safety tests

- **Kill-switch:** test immediate cancellation of all open orders and proper logging.
- **Over-limit test:** try to place order above allowed cap → expect rejection.

## 11 — Operational security & secrets

- **API keys:** store in encrypted secrets manager (Vault / AWS Secrets Manager / GCP Secret Manager). Never in repo.
- **Key permissions:** use keys with limited scopes (no withdrawals) and restrict IPs if possible.
- **Rotate keys** periodically; record rotation events in audit logs.
- **Access control:** 2FA and role-based access for admin endpoints.

## 12 — Example code snippets

### 12.1 Pre-trade check (simplified)

```python
def pre_trade_check(user, symbol, size_usd):
    bal = connector.get_balance()
    if size_usd > config.MAX_TRADE_USD:
        raise Exception("Trade exceeds per-trade cap")
    if ledger.daily_realized_loss < -config.MAX_DAILY_LOSS:
        raise Exception("Daily loss limit reached")
    if live_mode and not user.auto_mode_enabled:
        raise Exception("Auto-mode disabled")
    return True
```

### 12.2 Place order (simplified)

```python
order = connector.create_order(symbol, 'buy', 'limit', qty, price=best_ask*0.995)
db.orders.insert_one(order)
# monitor fills
while not filled and not timed_out:
    status = connector.fetch_order(order['id'])
    update_internal(order, status)
```

## 13 — Acceptance criteria (Phase 5 done)

- ✅ Exchange connector supports Binance testnet and passes full integration test (recommendation→approve→order→fill→reconcile).
- ✅ Risk manager consistently blocks trades violating configured caps.
- ✅ Kill-switch cancels all open orders and is audited.
- ✅ Proof-of-execution storage exists for all live/test trades.
- ✅ Reconciliation runs daily and reports < 0.1% unresolved discrepancy (configurable).
- ✅ Auto-mode can be toggled on/off and respects human approvals for large trades.
- ✅ Trading Control Center frontend exposes positions, orders, approvals, and risk widgets with Tailwind + shadcn across light/dark themes.
- ✅ Settings page persists risk limits + alert channels through `/api/settings/trading`.

## 14 — Post-launch guard rails & suggestions

- Start live with tiny allocation and strict caps (e.g., $100–$500/day limit) and monitor for N days.
- Run continuous A/B: new strategies tested in paper or micro-live for a minimum M days before scaling.
- Keep human-in-the-loop for large trades and major config changes.
- Log everything and back up audit logs off-site.

## 15 — Implementation Status (Nov 10, 2025)

**Backend**
- Exchange execution layer introduced under `exec/` with `ExchangeConnector`, `PaperConnector`, `OrderManager`, `RiskManager`, `TradeAuditor`, and `SettlementEngine` coordinating proofs-of-execution, ledger updates, and mode-aware routing (paper → testnet → live).
- Kill switch endpoint (`POST /api/admin/kill-switch`) halts trading and cancels outstanding orders; risk endpoints (`/api/risk/*`) surface summaries and breach acknowledgements; trading endpoints (`/api/trading/*`) drive order submission, cancellations, and ledger snapshots.
- Trading settings API (`GET/PUT /api/settings/trading`, `POST /api/settings/trading/test-alert`) persists guard rails, alert channels, and auto-mode defaults with Slack/Telegram/email integrations via `monitoring/trade_alerts.py`.

**Frontend**
- New Phase 5 control center at `/trading` with `TradingTabs`, `ApprovalWizard`, `OrderBlotter`, `PositionsTable`, `FillsFeed`, `KillSwitchPanel`, `RiskGaugeCard`, `ExposureDonutChart`, `ExecutionLatencyChart`, and `AlertStream` delivering live order management with mode switching.
- `/risk` dashboard visualises exposure, daily loss, and open breaches; `/settings/trading` manages caps, auto-mode thresholds, and alert channels via `SettingsTradingForm` and `AccountSelector`.
- Playwright coverage extended (`playwright/trading.spec.ts`) validating navigation to trading and risk workspaces.

**Testing**
- `tests/test_trading_phase5.py` exercises RiskManager guard rails, kill-switch behaviour, and paper order placement using `mongomock`.