# Phase 0 — Foundations (prep; quick wins)

**Working goal:** Get minute/hour/day historical data in MongoDB, compute features, run simple strategies in a simulator, and produce daily reports + a tiny Next.js dashboard. This gives you a runnable environment to iterate with real data.

## 1 — Minimal tech stack & tools

- **Python 3.11+**, pip
- **MongoDB** (local trough docker)
- **Node** (Next.js) for small dashboard (v18+)
- **Docker & docker-compose** 
- **Libraries (Python):** pandas, numpy, pymongo, ccxt, scikit-learn, pandas-ta (or ta), fastapi, uvicorn, joblib (for model saving), matplotlib/plotly (report charts), pytest
- **Frontend:** Next.js + React with Tailwind CSS, shadcn/ui component primitives, and light/dark theme toggle (class-based)

## 2 — Repo layout (single repo)

```
/lenxys-trader/
  /data_ingest/
    fetcher.py
    config.py
    schedule_fetch.sh
  /db/
    mongo_schema.md
    indexes.txt
  /features/
    features.py
    indicators.py
  /models/
    baseline.py
    rf_model.py
    model_utils.py
  /backtester/
    engine.py
    execution_model.py
  /simulator/
    account.py
    runner.py
  /api/
    main.py        # FastAPI
    routes/
      reports.py
      runs.py
      models.py
  /web/
    next-app/
      pages/
      components/
  /reports/
    generator.py
    templates/
  /docker/
    docker-compose.yml
    Dockerfile.python
    Dockerfile.next
  /scripts/
    seed_symbols.py
    run_all.sh
  README.md
  .gitignore
```

## 3 — Data model (MongoDB)

Create a database `lenxys` with these collections and example fields:

### ohlcv

```json
{
  "_id": ObjectId,
  "symbol": "BTC/USDT",
  "interval": "1m",
  "timestamp": ISODate("2025-11-03T12:34:00Z"),
  "open": 60000.0,
  "high": 60100.0,
  "low": 59900.0,
  "close": 60050.0,
  "volume": 12.34,
  "source": "binance"
}
```

**Index:** `{"symbol":1, "interval":1, "timestamp":1}` (unique)

### features

```json
{
  "_id": ObjectId,
  "symbol": "BTC/USDT",
  "interval": "1m",
  "timestamp": ISODate(...),
  "features": { "r_1m": 0.0012, "ema_9": 59920.1, "rsi_14": 62.3, ... }
}
```

**Index:** `{"symbol":1, "interval":1, "timestamp":1}`

### sim_runs

```json
{
  "_id": ObjectId,
  "run_id": "run-20251104-001",
  "start": ISODate(...),
  "end": ISODate(...),
  "strategy": "ema-cross-9-21",
  "account": "virt-01",
  "results": { "pnl": 123.45, "sharpe": 1.2, "max_dd": 0.12 },
  "trades": [ { "entry_ts":..., "entry_price":..., "size":..., "exit_ts":..., "pnl":... } ]
}
```

### daily_reports

```json
{
  "date": "2025-11-04",
  "generated_at": ISODate(...),
  "summary": "...",
  "top_strategies": [...],
  "charts": [ {"path": "reports/20251104/top_curve.png"} ],
  "raw": {...}
}
```

## 4 — Key components & example snippets

### 4.1 Data fetcher (data_ingest/fetcher.py)

- Use ccxt to fetch historical OHLCV
- Save normalized docs to ohlcv collection

```python
# simplified snippet
import ccxt, pymongo, time
from config import MONGO_URI, SYMBOLS, INTERVALS
client = pymongo.MongoClient(MONGO_URI)
db = client['lenxys']

exchange = ccxt.binance({'enableRateLimit': True})
def fetch_ohlcv(symbol, timeframe='1m', since=None, limit=1000):
    data = exchange.fetch_ohlcv(symbol, timeframe=timeframe, since=since, limit=limit)
    docs = []
    for o in data:
        ts = int(o[0])
        docs.append({
            "symbol": symbol, "interval": timeframe, "timestamp": datetime.utcfromtimestamp(ts/1000),
            "open": o[1], "high": o[2], "low": o[3], "close": o[4], "volume": o[5], "source": "binance"
        })
    if docs:
        db.ohlcv.insert_many(docs)
```

Schedule with cron or `schedule_fetch.sh` to run every minute/hour.

### 4.2 Feature builder (features/features.py)

Compute rolling returns, EMAs, RSI, MACD, vol

```python
import pandas as pd
import pandas_ta as ta
from db.client import get_ohlcv_df, write_features

def make_features(symbol, interval):
    df = get_ohlcv_df(symbol, interval)
    df['r_1m'] = df['close'].pct_change()
    df['ema_9'] = ta.ema(df['close'], length=9)
    df['ema_21'] = ta.ema(df['close'], length=21)
    df['rsi_14'] = ta.rsi(df['close'], length=14)
    df['vol_1h'] = df['close'].pct_change().rolling(60).std()  # if 1m interval
    # push to DB
    for idx, row in df.iterrows():
        write_features(symbol, interval, row)
```

### 4.3 Simple strategy & backtester (backtester/engine.py)

Event-driven loop reading features; produces signals; apply execution model (market orders + fixed slippage + fees)

```python
class Backtester:
    def __init__(self, initial_cap=10000, fee_pct=0.001):
        ...
    def step(self, timestamp, price, signal):
        if signal == 'buy' and not self.position:
            exec_price = price * (1 + self.slippage)
            qty = self.cash * self.position_size_pct / exec_price
            self.enter(exec_price, qty)
        if signal == 'sell' and self.position:
            ...
```

### 4.4 Simulator accounts (simulator/account.py)

- Virtual account tracks cash, positions, equity curve, trade log.
- Configurable risk profile: `position_size_pct`, `max_positions`, `stop_loss_pct`, `take_profit_pct`.

### 4.5 API (FastAPI) — minimal endpoints (api/main.py)

- `GET /api/status` — health
- `POST /api/admin/bootstrap` — seed symbols, fetch candles (configurable `symbols`, `intervals`, `lookback_days`), compute features, run baseline sim, generate report
- `GET /api/admin/overview` — returns MongoDB coverage summary (candles, features, latest timestamps) for dashboard confirmation
- `POST /api/run/sim` — start a simulation (payload: symbol, interval, strategy)
- `GET /api/run/sim` — list recent runs
- `GET /api/reports/{date}` — get daily report metadata / artifact

Example snippet:

```python
from fastapi import FastAPI
from routes import admin, reports, runs

app = FastAPI()
app.include_router(runs.router, prefix="/api/run")
app.include_router(reports.router, prefix="/api/reports")
app.include_router(admin.router, prefix="/api/admin")
```

### 4.6 Frontend scope (Phase 0 UI)

**New / Updated Pages**
- `/` — Bootstrap console + data coverage dashboard (uses `/api/status`, `/api/reports?limit=3`, `/api/admin/overview`, `/api/admin/bootstrap`).
- `/strategies` — Simulation run explorer (uses `/api/run/sim?limit=12`).
- `/reports` & `/reports/[date]` — Recent reports list and detail views (uses `/api/reports?limit=30`, `/api/reports/{date}`).
- `/settings` (new) — Frontend-only preferences page with theme toggle, auto-refresh interval, and API endpoint status summary; reads from local storage now and will connect to `/api/settings` once introduced in Phase 2.

**Key Components**
- `Layout`, `ThemeToggle` (global navigation + light/dark switch, using `next-themes`).
- shadcn primitives (`Card`, `Badge`, `Button`, `Checkbox`, `Input`, `Label`, `Table`, `Skeleton`, `Alert`) unified under `components/ui`.
- `BootstrapForm`, `CoverageTable`, `StrategySparkline`, `ReportList`, `ReportDetail`.

**Backend Integrations**
- Health & bootstrap: `GET /api/status`, `POST /api/admin/bootstrap`.
- Inventory & defaults: `GET /api/admin/overview`.
- Strategies: `GET /api/run/sim`.
- Reports: `GET /api/reports`, `GET /api/reports/{date}`.
- Settings stub: placeholder for `GET/PUT /api/settings` (implemented in Phase 2); until then, UI stores preferences locally.

**QA & Backlog**
- Replace remaining inline styles (reports pages) with Tailwind classes and shadcn typography.
- Add Playwright smoke test covering bootstrap flow, strategies selection, and report navigation in both themes.
- Storybook (or Ladle) stories for core components with mocked SWR data.

## 5 — Docker & run (dev)

**docker/docker-compose.yml**

```yaml
version: '3.7'
services:
  mongo:
    image: mongo:6
    ports: ["27017:27017"]
    volumes:
      - mongo-data:/data/db
  api:
    build: ../Dockerfile.python
    environment:
      - MONGO_URI=mongodb://mongo:27017
    depends_on:
      - mongo
  next:
    build: ../Dockerfile.next
    ports: ["3000:3000"]
    depends_on:
      - api
volumes:
  mongo-data:
```

**Build:** `docker-compose up --build`

## 6 — Config & secrets

**/.env** (do not commit to git)

```bash
MONGO_URI=mongodb://localhost:27017
BINANCE_API_KEY=
BINANCE_API_SECRET=
DEFAULT_SYMBOLS=BTC/USDT,ETH/USDT,SOL/USDT,BNB/USDT,DCR/USDT
```

**Security note:** never commit API keys; use system environment or secrets manager.

## 7 — Tests & QA

- **Unit tests** for feature generation: check EMA, RSI values for toy series.
- **Backtester regression tests:** run known scenario (synthetic data) and assert expected PnL.
- **API integration test:** call `POST /api/run/sim` with small date range and assert `sim_runs` created.

Example pytest test:

```python
def test_ema():
    from features import indicators
    series = pd.Series([1,2,3,4,5])
    assert round(indicators.ema(series, 3).iloc[-1],4) == expected_val
```

## 8 — Acceptance criteria (Phase 0 done)

- ✅ Historical OHLCV stored for all default symbols (1m, 1h, 1d).
- ✅ Features collection populated for 30 days of minute data.
- ✅ Able to run at least 10 simulated accounts for 30 days, storing `sim_runs`.
- ✅ Daily report (JSON + HTML) generated and reachable via API.
- ✅ Next.js dashboard shows list of strategies and 1 equity curve chart using Tailwind + shadcn components.
- ✅ Reports index/detail use shared design system with working light/dark toggle.
- ✅ Settings page exposes theme toggle + refresh interval, ready to sync with backend config once available.

## 9 — Roadmap to Phase 1

Once Phase 0 accepted, prepare model training pipelines and model storage (joblib) and move to **Phase 1: Multi-horizon forecast models**.

## 10 — Implementation Status (Nov 10, 2025)

**Completed**
- Project scaffold (`lenxys-trader/`) created with ingestion (`data_ingest/fetcher.py`), feature builder, simulator/backtester modules, and FastAPI API.
- Bootstrap workflow now supports configurable symbols/intervals with 30-day minute backfill, bulk feature generation, baseline simulation, and report generation exposed via `/api/admin/bootstrap`.
- `/api/admin/overview` surfaces live MongoDB coverage metrics (candles, features, latest timestamps) consumed by the dashboard.
- Next.js dashboard upgraded with shadcn UI: overview bootstrap console + coverage table, strategies explorer with equity sparkline + trade stats, and refreshed report summaries; Tailwind theme tokens already wired for class-based dark mode.
- Persistent light/dark theming shipped via `next-themes`, including a header toggle and Phase 0 settings page that stores theme + auto-refresh preferences in local storage.
- `/reports` index and detail screens rebuilt with shadcn cards/tables, richer empty/loading states, and direct links to generated artifacts.
- Docker stack (`docker/docker-compose.yml`) verified locally; MongoDB, API, and Next.js dashboard respond after `docker compose up --build`.

**Needs Review**
- Validate long-running ingestion scheduling (cron/worker) and ensure MongoDB indexes from `db/indexes.txt` are applied in deployed environments.
- Add automated tests for indicators/backtester, TypeScript linting, and CI wiring now that code exists.
- Harden configuration handling (environment secrets, Docker image slimming, production logging) before exposing services broadly.
- Address `npm audit` critical vulnerability introduced by frontend dependencies (or document risk acceptance).

**Phase 1 Readiness**
- ✅ Core Phase 0 deliverables run end-to-end inside containers.
- ✅ Dashboard confirms 30-day minute coverage per selected symbol/interval before moving forward.
- ⚠️ Recommend completing the reviews above plus a real-data dry run to confirm data quality.
- With those items in flight, the codebase is ready to start Phase 1 model development.